pipeline {
  agent any

  environment {
    IMAGE_NAME = "jenkins-cicd-pipeline" // local image name
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build Docker Image') {
      steps {
        sh "docker build -t ${IMAGE_NAME}:${env.BUILD_NUMBER} ."
      }
    }

    stage('Run Tests') {
      steps {
        // run tests inside container to match runtime
        sh "docker run --rm ${IMAGE_NAME}:${env.BUILD_NUMBER} /bin/sh -c 'pytest -q'"
      }
      post {
        failure {
          echo "Tests failed."
        }
      }
    }

    stage('Deploy (local)') {
      steps {
        sh """
          docker rm -f ${IMAGE_NAME}-running || true
          docker run -d --name ${IMAGE_NAME}-running -p 5000:5000 ${IMAGE_NAME}:${env.BUILD_NUMBER}
        """
      }
    }
  }

  post {
    always {
      echo "Cleaning workspace"
      cleanWs()
    }
  }
}
